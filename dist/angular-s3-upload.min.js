/*! angular-s3-upload - v0.0.26 - 2014-12-09
* Copyright (c) 2014 ; Licensed  */
"use strict";angular.module("angular-s3-upload-tpls",["templates/angular-s3-upload-button.html"]);var ngS3Upload=angular.module("angular-s3-upload",["angular-s3-upload-tpls"]);ngS3Upload.directive("ngS3Upload",["$upload","$q",function(a,b){return{restrict:"EA",replace:!0,scope:{label:"@",uploadHelper:"=",buttonClass:"@",index:"=",key:"@",path:"@",successCallback:"=",failureCallback:"=",progressCallback:"=",awsApi:"=",bucket:"@",filename:"@",maxWidth:"@",maxHeight:"@"},templateUrl:"templates/angular-s3-upload-button.html",link:function(a){a.awsApi.getAWSToken(a.key).then(function(b){a.aws={},a.aws.policy=b.policy,a.aws.signature=b.signature,a.aws.key=b.key},function(b){"undefined"!=typeof a.failureCallback&&a.failureCallback(b)})},controller:function(c){c.createUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})};var d=function(a){var b;b=a.split(",")[0].indexOf("base64")>=0?atob(a.split(",")[1]):unescape(a.split(",")[1]);for(var c=a.split(",")[0].split(":")[1].split(";")[0],d=new Uint8Array(b.length),e=0;e<b.length;e++)d[e]=b.charCodeAt(e);return{blob:new Blob([d],{type:c}),type:c}},e=function(a){var e=b.defer(),f=document.createElement("canvas"),g=new Image;return g.src=URL.createObjectURL(a),g.onload=function(){var a=f.getContext("2d");a.drawImage(g,0,0);var b=g.width,h=g.height;b>h?b>c.maxWidth&&(h*=c.maxWidth/b,b=c.maxWidth):h>c.maxHeight&&(b*=c.maxHeight/h,h=c.maxHeight),f.width=b,f.height=h,a=f.getContext("2d"),a.drawImage(g,0,0,b,h);var i=f.toDataURL("image/png",1);e.resolve(d(i))},e.promise};c.onFileSelect=function(a){for(var b=0;b<a.length;b++){var d=a[b];angular.isDefined(c.filename)||(c.filename=c.createUUID());var g=c.key+"/"+c.filename;angular.isDefined(c.path)&&(g=c.key+"/"+c.path+"/"+c.filename);var h={};angular.isDefined(c.maxWidth)&&angular.isDefined(c.maxHeight)?e(d).then(function(a){h={transformRequest:angular.identity,url:"https://"+c.bucket+".s3.amazonaws.com/",method:"POST",data:{key:g,acl:"public-read","Content-Type":a.type,AWSAccessKeyId:c.aws.key,Policy:c.aws.policy,Signature:c.aws.signature,file:a.blob}},f(h)}):(h={transformRequest:angular.identity,url:"https://"+c.bucket+".s3.amazonaws.com/",method:"POST",data:{key:g,acl:"public-read","Content-Type":d.type,AWSAccessKeyId:c.aws.key,Policy:c.aws.policy,Signature:c.aws.signature},file:d},f(h))}};var f=function(b){c.upload=a.upload(b).progress(function(a){"undefined"!=typeof c.progressCallback.progress&&c.progressCallback(a)}).success(function(a,b,d,e){"undefined"!=typeof c.successCallback&&c.successCallback(c.filename+"?cb="+(new Date).getTime().toString(),c.index,a,b,d,e)}).error(function(a,b,d,e){"undefined"!=typeof c.failureCallback&&c.failureCallback(c.index,a,b,d,e)})}}}}]),angular.module("templates/angular-s3-upload-button.html",[]).run(["$templateCache",function(a){a.put("templates/angular-s3-upload-button.html",'<div class="upload-button">\n	<button class="{{buttonClass}}" lng="{{label}}"></button>\n	<input type="file" ng-file-select="onFileSelect($files, index)"></input>\n</div>')}]);